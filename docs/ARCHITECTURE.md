# LLM Weaver - 系统架构设计文档

## 项目概述

**LLM Weaver** 是一个企业级LLM API中转服务平台，提供统一的API接口管理、智能路由、费用控制和全面监控能力。

## 核心特性

- **多供应商支持**：OpenAI、Anthropic、Google、Azure、本地模型等
- **OpenAI兼容接口**：完全兼容OpenAI API格式
- **智能路由**：基于成本、延迟、可用性的智能路由
- **费用控制**：API Key管理、预算限制、用量统计
- **高并发支持**：异步架构、连接池、缓存优化
- **安全性**：JWT认证、请求签名、IP白名单、敏感信息加密
- **美观前端**：Vue3 + TypeScript + Element Plus

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Web管理    │  │  API客户端   │  │      OpenAI SDK        │  │
│  │    前端      │  │  (原生接口)  │  │    (兼容接口)           │  │
│  └──────┬──────┘  └──────┬──────┘  └───────────┬─────────────┘  │
└─────────┼────────────────┼─────────────────────┼────────────────┘
          │                │                     │
          ▼                ▼                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                        接入网关层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Nginx     │  │  速率限制   │  │       负载均衡          │  │
│  │   (反向代理) │  │  (限流熔断) │  │      (多实例)           │  │
│  └──────┬──────┘  └─────────────┘  └─────────────────────────┘  │
└─────────┼────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                        核心业务层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  REST API   │  │   WebSocket │  │      Admin API          │  │
│  │  (FastAPI)  │  │  (实时推送)  │  │     (管理接口)          │  │
│  └──────┬──────┘  └─────────────┘  └─────────────────────────┘  │
└─────────┼────────────────────────────────────────────────────────┘
          │
    ┌─────┴─────┬─────────────┬─────────────┬────────────────┐
    ▼           ▼             ▼             ▼                ▼
┌────────┐ ┌─────────┐ ┌───────────┐ ┌──────────┐ ┌────────────┐
│        │ │         │ │           │ │          │ │            │
│ 认证   │ │ 路由    │ │   计费    │ │  日志    │ │   监控     │
│ 授权   │ │ 引擎    │ │   统计    │ │  记录    │ │   告警     │
│        │ │         │ │           │ │          │ │            │
└────────┘ └─────────┘ └───────────┘ └──────────┘ └────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                        上游供应商层                              │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ OpenAI  │ │Anthropic│ │  Gemini │ │  Azure  │ │ 本地模型 │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐              │
│  │ Mistral │ │  Cohere │ │  智谱    │ │  文心   │  ...        │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

## 技术选型

### 后端技术栈

| 组件 | 技术 | 说明 |
|------|------|------|
| 框架 | FastAPI (Python 3.11+) | 高性能异步Web框架 |
| 数据库 | PostgreSQL 15 | 主数据库 |
| 缓存 | Redis 7 | 缓存、会话、限流 |
| 队列 | Celery + Redis | 异步任务队列 |
| 日志 | ClickHouse | 日志存储与分析 |
| ORM | SQLAlchemy 2.0 | 数据库ORM |
| 迁移 | Alembic | 数据库迁移 |

### 前端技术栈

| 组件 | 技术 | 说明 |
|------|------|------|
| 框架 | Vue 3 | 渐进式JavaScript框架 |
| 语言 | TypeScript | 类型安全 |
| UI库 | Element Plus | UI组件库 |
| 状态管理 | Pinia | 状态管理 |
| 路由 | Vue Router 4 | 前端路由 |
| HTTP | Axios | HTTP客户端 |
| 图表 | ECharts | 数据可视化 |

### 部署架构

| 组件 | 技术 | 说明 |
|------|------|------|
| 容器化 | Docker + Docker Compose | 容器编排 |
| 反向代理 | Nginx | 负载均衡、SSL |
| 监控 | Prometheus + Grafana | 监控告警 |
| 日志 | Loki | 日志聚合 |

## 模块设计

### 1. 认证授权模块 (auth)

- JWT Token认证
- API Key管理
- 用户角色权限控制 (RBAC)
- OAuth2集成
- IP白名单

### 2. 路由引擎模块 (router)

- 基于权重的负载均衡
- 健康检查与故障转移
- 智能路由策略 (成本优先、速度优先、质量优先)
- 模型映射与转换
- 流式响应支持

### 3. 计费统计模块 (billing)

- Token用量统计 (输入/输出)
- 费用计算与扣减
- 预算设置与预警
- 充值与账单管理
- 多币种支持

### 4. 日志记录模块 (logging)

- 请求/响应日志
- 审计日志
- 性能指标
- 日志查询与导出
- 实时日志流

### 5. 上游适配模块 (providers)

- 统一供应商接口
- 供应商特定适配器
- 模型配置管理
- 自动发现与注册

## 数据流

### API请求流程

```
1. 客户端发送请求 (带API Key)
      │
      ▼
2. API Gateway接收请求
   ├── 限流检查
   ├── IP白名单验证
   └── SSL终止
      │
      ▼
3. 认证中间件
   ├── 验证API Key
   ├── 检查用户状态
   └── 获取用户配额
      │
      ▼
4. 路由引擎
   ├── 解析请求模型
   ├── 选择最佳上游
   └── 应用转换规则
      │
      ▼
5. 上游供应商调用
   ├── 构建特定格式请求
   ├── 发送请求
   └── 接收响应
      │
      ▼
6. 响应处理
   ├── 格式转换 (为标准格式)
   ├── 统计Token用量
   └── 记录日志
      │
      ▼
7. 返回客户端
   └── 标准格式响应
```

## 扩展性设计

### 水平扩展

- 无状态服务设计，支持多实例部署
- Redis共享会话与缓存
- 数据库读写分离

### 插件化架构

```
providers/
├── base.py              # 供应商基类
├── openai_provider.py   # OpenAI适配器
├── anthropic_provider.py # Anthropic适配器
├── azure_provider.py    # Azure适配器
└── custom/              # 自定义供应商
    ├── __init__.py
    └── local_provider.py
```

### 配置驱动

- 供应商配置动态加载
- 路由规则热更新
- 模型参数可配置

## 安全设计

1. **传输安全**：TLS 1.3加密
2. **认证安全**：API Key + JWT双因素
3. **数据安全**：敏感字段加密存储
4. **访问控制**：RBAC权限模型
5. **审计安全**：完整操作日志
6. **防护机制**：速率限制、防重放、SQL注入防护

## 性能优化

1. **连接池**：上游HTTP连接复用
2. **异步IO**：全链路异步处理
3. **缓存策略**：多级缓存 (本地+Redis)
4. **流式处理**：SSE流式响应透传
5. **批量处理**：统计、日志批量写入

## 监控告警

1. **系统指标**：CPU、内存、网络
2. **业务指标**：QPS、延迟、错误率
3. **自定义指标**：Token用量、费用统计
4. **告警通道**：邮件、Webhook、钉钉

## 部署模式

### Docker Compose (开发/测试)

```yaml
# docker-compose.yml
# 包含: app, db, redis, nginx, prometheus, grafana
```

### Kubernetes (生产)

```yaml
# k8s/
# ├── deployment.yaml
# ├── service.yaml
# ├── ingress.yaml
# └── hpa.yaml
```

## 版本规划

### v1.0.0 (MVP)
- 基础API中转
- OpenAI兼容接口
- 基础管理后台
- 4-5个主流供应商

### v1.1.0
- 智能路由
- 费用统计
- 预算控制

### v1.2.0
- 更多供应商
- 高级监控
- 团队/组织功能

### v2.0.0
- 多租户架构
- 企业级SSO
- 高级分析报表
